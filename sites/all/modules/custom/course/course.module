<?php

/**
 * @file course.module
 * Code for the Course module.
 */

include_once 'course.features.inc';

/**
 * Implements hook_init()
 */
function course_init() {
  
  $node = menu_get_object('node');
  
  // Redirect to fist lesson from unit content type page
  if ($node && $node->type === 'unit') {
    $book_link = $node->book;
    $next = book_next($book_link);
    drupal_goto($next['link_path'], array(), 301);
  }
}

/**
 * Gets node last visited by the user
 * @todo test case
 */
function course_last_visited_node($nid) {
  global $user;
  
  if ($user->uid == 0) {
    return $nid;
  }
  
  $sql = 'SELECT h.nid AS nid 
          FROM history h 
          INNER JOIN book b ON h.nid = b.nid
          INNER JOIN book c ON b.bid = c.bid
          INNER JOIN menu_links ml ON ml.mlid = b.mlid
          WHERE 
            c.nid = :nid
            AND h.uid = :uid
            AND ml.plid != 0
          ORDER BY h.timestamp DESC
          LIMIT 1';
  
  $result = db_query($sql, array(':nid' => $nid, ':uid' => $user->uid));
  
  foreach ($result as $record) {
    return $record->nid;
  }
  // user did not open any content this course
  return FALSE;
}

/**
 *
 * implements hook_block_info()
 */
function course_block_info() {
  $blocks['registration_form'] = array(
    'info' => t('Course registertion form'), 
  ); 
  return $blocks;
}

/**
 *
 * implements hook_block_view()
 */
function course_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'registration_form':
      return registration_form_block();
  }
}

/**
 * Gets the href to the first node of specified type in the book
 * @param string $node_type bundle name of the node href of is needed
 * @return href of the node
 */
function course_first_node_href($node_type, $book = NULL) {
   if(is_null($book)) {
      $book = course_node_book();
   }
   if(!$book) {
     return FALSE;
   }
   $item = $book;
   do {
     $node = menu_get_object('node', 1, $item['link_path']);
     if($node->type === $node_type) {
       return $item['href'];
     }
     $item = book_next($item);
   } while($item);
   return FALSE;
}

/**
 * Checks to see if current node is part of a book.
 * Returns book array if it is part of a book, FALSE is not.
 */
function course_node_book() {
  $node = menu_get_object();
  if ($node && isset($node->book)) {
    return $node->book;
  }
  return FALSE;
}