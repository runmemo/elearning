<?php
/**
 * @file
 * Code for the Course newsletter feature.
 */

include_once 'newsletter.features.inc';

/**
 *  Implements of hook_node_access()
 */
function newsletter_node_access($node, $op, $account) {

  // allow teacher to create newsletter.
  if($op == 'update' && $node->type == 'newsletter' && !course_is_teacher($node, $account)) {
    return NODE_ACCESS_DENY;
  }
  
  // Allow registered students to access the newsletter.
  if(isset($node->type) && $node->type === 'newsletter' && $op == 'view') {
    $item = entity_metadata_wrapper('node', $node);
    $course = $item->field_course->value();
    if(!course_registration_id($account->uid, $course->nid)) {
      return NODE_ACCESS_DENY;
    }
  }
}

/*
 * Implements hook_form_FORM_ID_alter.
 *
 */
function newsletter_form_newsletter_node_form_alter(&$form, &$form_state) {
  $compressed_path = isset($_GET['path']) ? $_GET['path'] : '';
  if ($compressed_path) {
    $original_path = relevant_answers_decompress_string($compressed_path);
    $langcode = field_language('node', $form_state['node'], 'field_course');
    $form['field_course'][$langcode]['#default_value'][] = $original_path;
    $form['field_course']['#disabled'] = TRUE;
  }
}
