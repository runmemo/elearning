<?php

/**
 * @file
 * 
 * Test cases for the newsletter module.
 * 
 */

/**
 * Base class for newsletter tests.
 */
class NewsLetterBaseCase extends DrupalWebTestCase {

  function setUp() {
    parent::setUp('newsletter', 'newsfeed');
  }

  /**
   * Creates newsletter node
   * @return newsletter node
   */
  function create_newsletter($nid) {
     // create newsletter node
    $settings = array(
      'type' => 'newsletter',
      'title' => $this->randomName(10),
      'uid' => 1, // admin for now
    );
    $settings['field_course'][LANGUAGE_NONE][]['target_id'] = $nid; 
    return $this->drupalCreateNode($settings);
  }

}

/**
 * Tests checks install of newsletter module.
 */
class NewsletterCase extends NewsLetterBaseCase {

  public static function getInfo() {
    return array(
      'name' => 'Newsletter test',
      'description' => 'Test to check newsletter module setup and main functions',
      'group' => 'Course',
    );
  }

  function setUp() {
    parent::setUp();
  }
  
  /**
   * Tests newsletter creation.
   */
  function testCreateNewsletter() {
    $info = field_info_instance('node', 'field_course', 'newsletter');
    $this->assertNotNull($info);
    $info = field_info_instance('message', 'field_course', 'newsletter_notification');
    $this->assertNotNull($info);
    $info = field_info_instance('message', 'field_message_newsletter', 'newsletter_notification');
    $this->assertNotNull($info);
    $course = $this->drupalCreateNode(array('type' => 'course'));
    // Create newsletter.
    $newsletter = $this->create_newsletter($course->nid);
    $this->assertTrue($newsletter, 'NewsLetter is created, successfully.');
    

  }
  
  /**
   * Test newsletter notification process.
   */
  function testNewsletterNotification() {
    $course = $this->drupalCreateNode(array('type' => 'course'));
    $user = $this->drupalCreateUser();
    $flag = flag_get_flag('follow_content');
    $flag->flag('flag', $course->nid, $user, TRUE);
    $this->create_newsletter($course->nid);
    $this->assertMail('key', 'newsletter_notification');
  }
}
