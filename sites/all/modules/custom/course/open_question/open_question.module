<?php

/**
 * @file
 * Code for the Open Question feature.
 */
include_once 'open_question.features.inc';

/**
 * Implements hook_block_info()
 */
function open_question_block_info() {
  $blocks['oq_answer_form_block'] = array(
    'info' => t('OQ Answer Form Block'),
  );
  $blocks['oq_other_answers_block'] = array(
    'info' => t('OQ Answers Review List'),
  );
  return $blocks;
}

/**
 * Implements hook_permission()
 */
function opent_question_permission() {
  return array(
    'create open question' => array(
      'title' => 'Create open question',
      'description' => 'Allows user to create open questions.'
    )
  );
}

/**
 * Implements hook_block_view
 */
function open_question_block_view($delta = '') {
  $block = array();
  $question = menu_get_object('node');
  
  $answered = open_question_is_answered($question->nid);

  switch ($delta) {
    case 'oq_answer_form_block':
      $block['subject'] = '';

      if (!node_access('create', 'open_question_answer')) {
        // user does not have rights to see the form
        $block['content'] = t('You need to register to answer this question.');
        return $block;     
      }
      
      // add answer form
      $block['content']['answer_form']= drupal_get_form('open_question_answer_form', $answered);
      // embed view 
      if ($answered) {
        $block['content']['questions_list'] = array(
          '#type' => 'markup',
          '#markup' => open_question_get_answer_feedbacks($answered),
        );
      }
      
      break;
    case 'oq_other_answers_block':
      $block['subject'] = '';
     
      if ($answered) {
        $block['content'] = open_question_answered_content();
      } 
      else {
        $block['content']['message'] = array(
         '#type' => 'markup',
         '#markup' => t('You need to answer question before you can review answers of other students.'),
        );
      }
    break;
  }
  return $block;
}

/*
 * Get content for answered open question.
 */

function open_question_answered_content() {
  $block_content = array();
  $block_content['message'] = array(
    '#type' => 'markup',
    '#markup' => t('Please review and mark answers of other students.'),
  );
  // show answers of other students for review
  $review_list_view = views_get_view('open_questions_review_list');
  $block_content['review_list'] = array(
    '#type' => 'markup',
    '#markup' => $review_list_view->preview(),
  );
  return $block_content;
}

/**
 * Implementation of hook_rules_event_info()
 */
function open_question_rules_event_info() {
  return array(
    'open_question_answered' => array(
      'label' => t('Open question complete'),
      'module' => 'open_question',
      'group' => 'Course' ,
      'variables' => array(
        'answered_by' => array('type' => 'user', 'label' => t('User who answered the open question.')),
        'open_question' => array('type' => 'node', 'label' => t('The open question that was answered.')),
      ),
    ),
  );
}

/**
 * Gets nid of answer by user to open question
 * @global object $user current user
 * @param integer $nid
 * @param integer $uid
 * @return integer nid of user's answer to open question
 */
function open_question_is_answered($nid, $uid = NULL) {
  if (is_null($uid)) {
    global $user;
    $uid = $user->uid;
  }
  // count number of answers given by user
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'open_question_answer')
      ->propertyCondition('status', 1)
      ->propertyCondition('uid', $uid)
      ->fieldCondition('field_open_question', 'target_id', $nid)
      ->range(0, 1); // this is just to improve db performance

  $result = $query->execute();

  foreach ($result as $entity_type => $entities) {
    foreach ($entities as $entity_id => $entity) {
      return $entity_id;
    }
  }

  return FALSE;
}

/**
 * Form for providing an answer to an open question
 */
function open_question_answer_form($form, &$form_state, $answered) {
  //debug($form_state['step']);
  $form = array();
  $form['#prefix'] = '<div id="oq-answer-form-wrapper">';
  $form['#suffix'] = '</div>';

  $nid = 0;
  if (empty($form_state['step'])) {  // page is loaded
    $question = menu_get_object('node');
    if ($question && $question->type === 'open_question') {
      $nid = $question->nid;
      $form_state['question_nid'] = $nid;
    }
    else { // this is not a page of open question
      return $form;
    }

    // check whether user already has an answer to this question
    $form_state['answer_nid'] = $answered;
    if ($answered) {
      $mode = 'view';
    }
    else {
      $mode = 'edit';
    }
    $form_state['step'] = $mode;
  }
  else {
    $answered = $form_state['asnwer_nid'];
    $mode = $form_state['step'];
  }

  // build form depending on it's current mode
  switch ($mode) {
    case 'edit' :
      // build form for editing
      $form['edit']['new_answer'] = array(
        '#type' => 'textarea',
        '#default_value' => empty($form_state['answer_value']) ? '' : $form_state['answer_value'],
      );
      $form['edit']['save'] = array(
        '#type' => 'submit',
        '#submit' => array('open_question_answer_submit'),
        '#value' => t('Save'),
        '#ajax' => array(
          'callback' => 'open_question_answer_submit_js',
          'wrapper' => 'oq-answer-form-wrapper',
          'progress' => array('message' => t('')),
        ),
      );
      if (!empty($form_state['answer_value'])) {
        // add cancellation button
        // @todo
      }
      break;
    case 'view':
      if (!empty($form_state['answer_value'])) {
        $answer_text = $form_state['answer_value'];
        debug($answer_text);
      }
      else {
        $answer = node_load($answered);
        $answer_text = $answer->body[LANGUAGE_NONE][0]['value'];
        $form_state['answer_value'] = $answer_text;
      }
      // build form for viewing of saved answer
      $form['view']['edit'] = array(
        '#type' => 'submit',
        '#value' => t('Edit'),
        '#submit' => array('open_question_answer_submit'),
        '#ajax' => array(
          'callback' => 'open_question_answer_submit_js',
          'wrapper' => 'oq-answer-form-wrapper',
          'progress' => array('message' => t('')),
        ),
      );
      $form['view']['answer'] = array(
        '#type' => 'markup',
        '#prefix' => '<div class = "oq_answer">',
        '#suffix' => '</div>',
        '#markup' => $answer_text,
      );

      break;
    default :
      $form['bad_state'] = array(
        '#type' => 'markup',
        '#markup' => 'State ' . $mode . ' is not supported by this form.',
      );
  }

  return $form;
}

/**
 * 
 */
function open_question_answer_submit($form, &$form_state) {

  $oq_nid = $form_state['question_nid'];
  
  global $user;
  // User clicked Save button in edit mode
  if ($form_state['triggering_element']['#value'] == t('Save')) {

    if (empty($form_state['answer_nid']) || !$form_state['answer_nid']) {
      // its a new answer
      $node = new stdClass();
      $node->type = 'open_question_answer';
      node_object_prepare($node);
      $node->title = 'OQ anwer nid#' . $oq_nid . '# uid#' . $user->uid;
      $node->language = LANGUAGE_NONE;
      $node->body[$node->language][0]['value'] = $form_state['values']['new_answer'];
      $node->body[$node->language][0]['format'] = 'filtered_html';
      $node->field_open_question[LANGUAGE_NONE][0]['target_id'] = $oq_nid;

      node_save($node);
      $form_state['answer_nid'] = $node->nid;
      $oq = node_load($oq_nid);
      // question is now answered by user:
      rules_invoke_event('open_question_answered', $user, $oq);
    }
    else { // user changed existing answer
      debug('Updating existing node' . $form_state['answer_nid']);
      $node = node_load($form_state['answer_nid']);
      $node->body[$node->language][0]['value'] = $form_state['values']['new_answer'];
      node_save($node);
    }   
    $form_state['answer_value'] = $form_state['values']['new_answer'];
    $form_state['step'] = 'view';
  }
  // User clicked Edit button in view mode.
  if ($form_state['triggering_element']['#value'] == t('Edit')) {
    $form_state['step'] = 'edit';
  }

  $form_state['rebuild'] = TRUE;
}

/**
 * Callback for open question answer submit
 */
function open_question_answer_submit_js($form, $form_state) {
  $commands[] = ajax_command_replace('#block-open-question-oq-other-answers-block', render(open_question_answered_content()));

  $form_rebuilt = drupal_rebuild_form('open_question_answer_form', $form_state, array());

  $commands[] = ajax_command_replace('#oq-answer-form-wrapper',  render($form_rebuilt));
  return array('#type' => 'ajax', '#commands' => $commands);
}

/**
 * Returns embedded view on open question page.
 * @param type $oq_nid
 * @return string HTML for a view with feedbacks or an empty string.
 */
function open_question_get_answer_feedbacks($oqa_nid = NULL) {

  if ($oqa_nid) {
    $view_obj = views_get_view('oqa_feedbacks');
    $view = $view_obj->preview('block', array($oqa_nid));
  }
  else {
    $view = '';
  }
  return $view;
}


/**
 * Implements hook_flag_access_multiple().
 */
function open_question_flag_access_multiple($flag, $content_ids, $account) {
  $access = array();
  if ($flag->name == 'best_answer') {
    $node = menu_get_object('node');
    if ($node && $node->uid != $account->uid) {      
      foreach ($content_ids as $id => $action) {
        $access[$id] = FALSE;
      }
    }
  }
  return $access;
}

/**
 * Helper function, that removes old value from the "field_best_answer" field.
 * @param object $question
 * @param int $unflagged_answer_nid
 */
function open_question_remove_best_answer($question, $unflagged_answer_nid) {
  $lang = field_language('node', $question, 'field_best_answer');
  if (isset($question->field_best_answer[$lang])) {
    $old_answer = answers_field_get_node_reference($question, 'field_best_answer');
    if ($old_answer) {
      $lang = field_language('node', $old_answer, 'field_best_answer_p');
      $old_answer->field_best_answer_p[$lang][0]['value'] = 0;
      node_save($old_answer);
      if ($old_answer->nid == $unflagged_answer_nid) {
        $question->field_best_answer[$lang] = array();
      }
    } else {
      $question->field_best_answer[$lang] = array();
    }
    node_save($question);
    if (module_exists('rules')) {
      if ($old_answer) {
        rules_invoke_event('best_answer_unset', $question, $old_answer);
      }
    }
  }
}

/**
 * Implements hook_forms().
 */
function open_question_forms($form_id, $nid) {
  $forms = array();
  if (strpos($form_id, 'oq_review_') === 0) {
    $forms[$form_id] = array(
      'callback' => 'oq_review_form',
      'callback arguments' => array($nid),
    );
  }
  return $forms;
}

function oq_review_form($form, &$form_state, $args) {
  global $user;
  $form = array();
  $nid = $args[0]; 

  $form['#prefix'] = "<div id=oq-review-wrapper-{$nid}>";
  $form['#suffix'] = '</div>';

  $is_reviewed = oqa_is_reviewed($nid, $user->uid);
  if($is_reviewed) {
    $review_node = node_load($is_reviewed);
    $rating = array('rating' => $review_node->field_rating[LANGUAGE_NONE][0]['rating']);
    drupal_add_css(drupal_get_path('module', 'fivestar') . '/css/fivestar.css');
    $form['rating'] = array(
      '#type' => 'item',
      '#title' => 'Rating',
      '#markup' => theme('fivestar_static', $rating), // $review_node->body[LANGUAGE_NONE][0]['value'],
    );
    $form['review'] = array(
      '#type' => 'item',
      '#title' => 'Review',
      '#markup' => $review_node->body[LANGUAGE_NONE][0]['value'],
    );
  }
  else {
    $form['rating'] = array(
      '#type' => 'fivestar',
      '#title' => 'Rating',
      '#required' => 'true',
    );
    $form['review'] = array(
      '#type' => 'textarea',
      '#title' => 'Review',
      '#required' => 'true'
    );
  
    $form['submit_button'] = array(
      '#type' => 'submit',
      '#value' => 'OK',
      '#ajax' => array(
        'callback' => 'oq_review_form_submit',
        'wrapper' => "oq-review-wrapper-{$nid}",
      ),
    );
  }


  return $form;
}

function oqa_is_reviewed($nid, $uid = NULL) {
  if (is_null($uid)) {
    global $user;
    $uid = $user->uid;
  }
  // count number of answers given by user
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'open_question_feedback')
      ->propertyCondition('status', 1)
      ->propertyCondition('uid', $uid)
      ->fieldCondition('field_open_question_answer', 'target_id', $nid)
      ->range(0, 1); // this is just to improve db performance

  $result = $query->execute();

  foreach ($result as $entity_type => $entities) {
    foreach ($entities as $entity_id => $entity) {
      return $entity_id;
    }
  }

  return FALSE; 

}

function oq_review_form_submit($form, &$form_state) {
  // validate the form
  drupal_validate_form('oq_review_form', $form, $form_state);
  // if there are errors, return the form to display the error messages
  if (form_get_errors()) {
    $form_state['rebuild'] = TRUE;
    return $form;
  }


  global $user;
  $oq_nid = $form_state['build_info']['args'][0];

  $node = new stdClass();
  $node->type = 'open_question_feedback';
  node_object_prepare($node);
  $node->title = 'OQ feedback nid#' . $oq_nid . '# uid#' . $user->uid;
  $node->language = LANGUAGE_NONE;
  $node->body[$node->language][0]['value'] = $form_state['values']['review'];
  $node->body[$node->language][0]['format'] = 'filtered_html';
  $node->field_open_question_answer[$node->language][0]['target_id'] = $oq_nid;
  $node->field_rating[$node->language][0]['rating'] = $form_state['values']['rating'];
  node_save($node);

  $form_rebuilt = drupal_rebuild_form("oq_review_{$oq_nid}", $form_state, $form);
  $commands[] = ajax_command_replace("#oq-review-wrapper-{$oq_nid}", render($form_rebuilt));
  return array('#type' => 'ajax', '#commands' => $commands);
}
