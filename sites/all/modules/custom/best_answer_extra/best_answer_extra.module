<?php

/**
 * @file
 * Additional functionality to Best Answer module.
 */

/**
 * Implements hook_flag_access_multiple().
 */
function best_answer_extra_flag_access_multiple($flag, $content_ids, $account) {
  // @todo Ilya: find a better way to show best answer to others
  $access = array();
  if ($flag->name == 'best_answer') {
    $node = menu_get_object('node');
    if ($node && $node->uid != $account->uid) {
      $lang = field_language('node', $node, 'field_best_answer');
      $best = isset($node->field_best_answer[$lang][0]['nid']) ? $node->field_best_answer[$lang][0]['nid'] : FALSE;
      if ($best) {
        drupal_add_js(array('best_answer' => array('nid' => $best)), 'setting');
      }
      foreach ($content_ids as $id => $action) {
        $access[$id] = FALSE;
      }
    }
  }
  return $access;
}

/**
 * Implements hook_node_view().
 */
function best_answer_extra_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'question' && $view_mode == 'full') {
    drupal_add_js(drupal_get_path('module', 'best_answer_extra') . '/best_answer_extra.js');
  }
}

/**
 * Implements hook_flag().
 *
 * @param $op
 *  The operation being performed: one of 'flag' or 'unflag'.
 * @param $flag
 *  The flag object.
 * @param $content_id
 *  The id of the content (aka entity) the flag is on.
 * @param $account
 *  The user account performing the action.
 * @param $fcid
 *  The id of the flagging in the {flag_content} table.
 */
function best_answer_extra_flag($op, $flag, $content_id, $account, $fcid) {
  if ($flag->name == 'best_answer') {
    $answer_node = node_load($content_id);
    $question = answers_field_get_node_reference($answer_node, 'field_answer_question');
    if ($op == 'flag') {
      _best_answer_update_best_answer($question, $content_id);
    }
    elseif ($op == 'unflag') {
      best_answer_extra_remove_best_answer($question, $content_id);
    }
  }
}

/**
 * Unsets best question on unflagging answer and makes empty
 * corresponding question field, if unselected answer was set as best answer.
 * @param object $question
 * @param indteger $answer_nid
 */
function best_answer_extra_remove_best_answer($question, $answer_nid) {
  $lang = field_language('node', $question, 'field_best_answer');
  if (isset($question->field_best_answer[$lang]) 
        && $answer_nid == $question->field_best_answer[$lang][0]['nid']) {

    // clear the reference to best answer from question
    unset($question->field_best_answer[$lang]);
    node_save($question);
    // reset the flag on the answer
    best_answer_remove_flag($answer_nid);
    // trigger rule event 
    if (module_exists('rules')) {
      rules_invoke_event('best_answer_unset', $question, $answer_node);
    }
  }
  else { // question does not have best answer or it has different answer selected as best
    // reset the flag on the answer
    best_answer_remove_flag($answer_nid);
    watchdog('best answer', 
        'Answer was with %answer_nid was not set as best on the question node with id %quesion_nid.', 
        array('%answer_nid' => $answer_nid, '%question_nid' => $question->nid,));
  }
}

/**
 * Sets field_best_answer_p from best answers module to zero
 * @param integer $answer_nid
 */
function best_answer_remove_flag($answer_nid) {
  $answer = node_load($answer_nid);
  if ($answer) {
    $lang = field_language('node', $answer, 'field_best_answer_p');
    $answer->field_best_answer_p[$lang][0]['value'] = 0;
    node_save($answer);   
  }
}