<?php

/**
 * @file
 * Additional functionality to Best Answer module.
 */

/**
 * Implements hook_flag_access_multiple().
 */
function best_answer_extra_flag_access_multiple($flag, $content_ids, $account) {
  // @todo Ilya: find a better way to show best answer to others
  $access = array();
  if ($flag->name == 'best_answer') {
    $node = menu_get_object('node');
    if ($node && $node->uid != $account->uid) {
      $lang = field_language('node', $node, 'field_best_answer');
      $best = isset($node->field_best_answer[$lang][0]['nid']) ? $node->field_best_answer[$lang][0]['nid'] : FALSE;
      if ($best) {
        drupal_add_js(array('best_answer' => array('nid' => $best)), 'setting');
      }
      foreach ($content_ids as $id => $action) {
        $access[$id] = FALSE;
      }
    }
  }
  return $access;
}

/**
 * Implements hook_node_view().
 */
function best_answer_extra_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'question' && $view_mode == 'full') {
    drupal_add_js(drupal_get_path('module', 'best_answer_extra') . '/best_answer_extra.js');
  }
}

/**
 * Implements hook_flag().
 *
 * @param $op
 *  The operation being performed: one of 'flag' or 'unflag'.
 * @param $flag
 *  The flag object.
 * @param $content_id
 *  The id of the content (aka entity) the flag is on.
 * @param $account
 *  The user account performing the action.
 * @param $fcid
 *  The id of the flagging in the {flag_content} table.
 */
function best_answer_extra_flag($op, $flag, $content_id, $account, $fcid) {
  if ($flag->name == 'best_answer') {
    $new_best_answer = node_load($content_id);
    $question = answers_field_get_node_reference($new_best_answer, 'field_answer_question');
    if ($op == 'flag') {
      _best_answer_update_best_answer($question, $content_id);
    } elseif ($op == 'unflag') {
      best_answer_extra_remove_best_answer($question, $content_id);
    }
  }
}

/**
 * Unsets best question on unflagging answer and makes empty
 * corresponding question field, if unselected answer was set as best answer.
 * @param type $question
 * @param type $answer_id
 */
function best_answer_extra_remove_best_answer($question, $answer_id) {
  $lang = field_language('node', $question, 'field_best_answer');
  if (isset($question->field_best_answer[$lang])) {
    if ($answer_id == $question->field_best_answer[$lang][0]['nid']) {
      $old_answer = node_load($answer_id);
      $lang = field_language('node', $old_answer, 'field_best_answer_p');
      $old_answer->field_best_answer_p[$lang][0]['value'] = 0;
      node_save($old_answer);
      $question->field_best_answer = array();
      node_save($question);
      if (module_exists('rules')) {
        if ($old_answer) {
          rules_invoke_event('best_answer_unset', $question, $old_answer);
        }
      }
    }
  }
}
